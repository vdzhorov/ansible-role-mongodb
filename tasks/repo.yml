---

- name: Fetch MongoDB 8.0 repository key (ASCII armored)
  ansible.builtin.get_url:
    url: "{{ mongodb_repo_key_url }}"
    dest: "/usr/share/keyrings/mongodb-server-8.0.asc"
    mode: '0644'

- name: Convert MongoDB key to dearmored .gpg keyring
  ansible.builtin.command:
    cmd: >
      gpg --dearmor
      --output {{ mongodb_repo_keyring_path }}
      /usr/share/keyrings/mongodb-server-8.0.asc
  args:
    creates: "{{ mongodb_repo_keyring_path }}"

- name: Ensure permissions on keyring
  ansible.builtin.file:
    path: "{{ mongodb_repo_keyring_path }}"
    mode: '0644'
    owner: root
    group: root

- name: Add MongoDB APT repository (Ubuntu 24.04 Noble)
  ansible.builtin.apt_repository:
    repo: "{{ mongodb_repo_line }}"
    filename: "mongodb-org-{{ mongodb_repo_series }}"
    state: present

- name: Update APT cache (force refresh)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 0

